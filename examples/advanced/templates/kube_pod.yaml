rows:
  title: Kubernetes Pod
  collapse: true
  showTitle: true
  height: 300px
  panels:
    - title: CPU Usage
      datasource: q5KtSq17z
      span: 4
      fill: 0
      seriesOverrides:
        - alias: limit
          color: '#FF0000'
          hideTooltip: true
          legend: false
          nullPointMode: connected
        - alias: request
          color: '#00FF04'
          hideTooltip: true
          legend: false
          nullPointMode: connected
      legend:
        alignAsTable: true
        current: true
        sort: current
        show: true
        values: true
        sortDesc: true
      tooltip:
        shared: true
        sort: 2
        value_type: individual
      targets:
        - expr: >-
            sum by (pod, container) (irate(container_cpu_usage_seconds_total{dh_cluster="$dh_cluster",
            namespace="$namespace", container!="POD", container!="", pod=~".*$app.*"}[$__rate_interval]))
          legendFormat: '{{container}} in {{pod}}'
        - expr: >-
            min by (container) (kube_pod_container_resource_limits{dh_cluster="$dh_cluster", namespace="$namespace",
            resource="cpu", unit="core", pod=~".*$app.*"})
          legendFormat: 'Limit: {{ container }}'
        - expr: >-
            min by (container) (kube_pod_container_resource_requests{dh_cluster="$dh_cluster", namespace="$namespace",
            resource="cpu", unit="core", pod=~".*$app.*"})
          legendFormat: 'Request: {{ container }}'
      type: graph
    - title: Memory Limit Usage
      datasource: q5KtSq17z
      span: 4
      fill: 0
      legend:
        alignAsTable: true
        current: true
        sort: current
        show: true
        values: true
        sortDesc: true
      tooltip:
        shared: true
        sort: 2
        value_type: individual
      targets:
        - expr: >-
            avg by (pod, container) (container_memory_working_set_bytes{dh_cluster="$dh_cluster",
            namespace="$namespace", container!="POD", container!="", pod=~".*$app.*"}) / avg by (pod, container)
            (container_spec_memory_limit_bytes{dh_cluster="$dh_cluster", namespace="$namespace",
            container!="POD", container!="", pod=~".*$app.*"})
          legendFormat: '{{container}} in {{pod}}'
      type: graph
      format: percentunit
      yaxes:
        - format: percentunit
          decimals: 2
          min: 0
          max: 1
          show: true
        - show: false
    - title: Disk IO
      datasource: q5KtSq17z
      span: 4
      fill: 0
      yaxes:
        - format: Bps
          show: true
        - decimals: 0
          show: false
      legend:
        alignAsTable: true
        current: true
        sort: current
        show: true
        values: true
        sortDesc: true
      tooltip:
        shared: true
        sort: 2
        value_type: individual
      targets:
        - expr: >-
            sum by (pod) (irate(container_fs_writes_bytes_total{dh_cluster="$dh_cluster",
            namespace="$namespace", container!="POD", container!="", pod=~".*$app.*"}[$__rate_interval]))
          legendFormat: '{{ pod }} disk write'
        - expr: >-
            -sum by (pod) (irate(container_fs_reads_bytes_total{dh_cluster="$dh_cluster",
            namespace="$namespace", container!="POD", container!="", pod=~".*$app.*"}[$__rate_interval]))
          legendFormat: '{{ pod }} disk read'
      type: graph
    - title: Pod Restarts
      datasource: q5KtSq17z
      span: 4
      legend:
        alignAsTable: true
        current: true
        sort: current
        show: true
        values: true
        sortDesc: true
      tooltip:
        shared: true
        sort: 2
        value_type: individual
      targets:
        - expr: >-
            sum by (pod) (delta(kube_pod_container_status_restarts_total{dh_cluster="$dh_cluster",
            namespace="$namespace", pod=~".*$app.*"}[$__rate_interval]))
          legendFormat: '{{ pod }}'
      type: graph
    - title: Network IO
      datasource: q5KtSq17z
      span: 4
      fill: 0
      yaxes:
        - format: Bps
          show: true
        - decimals: 0
          show: false
      legend:
        alignAsTable: true
        current: true
        sort: current
        show: true
        values: true
        sortDesc: true
      tooltip:
        shared: true
        sort: 2
        value_type: individual
      targets:
        - expr: >-
            sum by (pod) (irate(container_network_receive_bytes_total{dh_cluster="$dh_cluster",
            namespace="$namespace", pod=~".*$app.*"}[$__rate_interval]))
          legendFormat: '{{pod}} network recv bytes'
        - expr: >-
            -sum by (pod) (irate(container_network_transmit_bytes_total{dh_cluster="$dh_cluster",
            namespace="$namespace", pod=~".*$app.*"}[$__rate_interval]))
          legendFormat: '{{pod}} network sent bytes'
      type: graph
    - title: HPA Status
      datasource: q5KtSq17z
      span: 4
      fill: 0
      seriesOverrides:
        - alias: 'CPU request usage'
          color: '#C334EB'
        - alias: 'Pods running'
          color: '#34EB4F'
          yaxis: 2
        - alias: 'HPA max replicas'
          color: 'rgba(112, 112, 112, 0.26)'
          fillBelowTo: 'HPA min replicas'
          hideTooltip: true
          legend: false
          lineWidth: 0
          yaxis: 2
        - alias: 'HPA min replicas'
          color: 'rgba(112, 112, 112, 0.26)'
          hideTooltip: true
          legend: false
          lineWidth: 0
          yaxis: 2
        - alias: 'HPA threshold'
          color: '#F2495C'
          dashLength: 2
          dashes: true
          lineWidth: 2
          spaceLength: 3
      yaxes:
        - format: percentunit
          show: true
          min: 0
          label: CPU
        - format: short
          show: true
          min: 0
          label: Pods
      legend:
        alignAsTable: true
        current: true
        sort: current
        show: true
        values: true
        sortDesc: true
      tooltip:
        shared: true
        sort: 2
        value_type: individual
      targets:
        - expr: 'kube_hpa_spec_target_metric{dh_cluster="$dh_cluster", hpa=~".*$app.*"}'
          legendFormat: 'HPA target'
        - expr: 'kube_hpa_spec_min_replicas{dh_cluster="$dh_cluster", hpa=~".*$app.*"}'
          legendFormat: 'HPA min replicas'
        - expr: 'kube_hpa_spec_max_replicas{dh_cluster="$dh_cluster", hpa=~".*$app.*"}'
          legendFormat: 'HPA max replicas'
        - expr: >-
            sum by (pod, namespace) (irate(container_cpu_usage_seconds_total{dh_cluster="$dh_cluster",
            namespace="$namespace", pod=~".*$app.*"}[$__rate_interval])) / sum by
            (pod, namespace) (kube_pod_container_resource_requests {dh_cluster="$dh_cluster",
            namespace="$namespace", resource="cpu", unit="core", pod=~".*$app.*"})
          legendFormat: 'CPU request usage - {{ pod }}'
        - expr: >-
            sum(kube_pod_status_phase{dh_cluster="$dh_cluster", namespace="$namespace", pod=~".*$app.*",
            phase="Running"} > 0)
          legendFormat: 'Pods running'
      type: graph
    - title: Network Transmit Errors
      datasource: q5KtSq17z
      span: 4
      yaxes:
        - show: true
          min: 0
        - show: false
      legend:
        alignAsTable: true
        current: true
        sort: current
        show: true
        values: true
        sortDesc: true
      tooltip:
        shared: true
        sort: 2
        value_type: individual
      targets:
        - expr: >-
            sum by (pod) (irate(container_network_transmit_errors_total{dh_cluster="$dh_cluster",
            namespace="$namespace", pod=~".*$app.*"}[$__rate_interval]))
          legendFormat: '{{pod}}'
      type: graph
    - title: CPU Throttle Seconds
      datasource: q5KtSq17z
      span: 4
      yaxes:
        - format: dtdurations
          show: true
        - decimals: 0
          show: false
      legend:
        alignAsTable: true
        current: true
        sort: current
        show: true
        values: true
        sortDesc: true
      tooltip:
        shared: true
        sort: 2
        value_type: individual
      targets:
        - expr: >-
            sum by (pod, container) (rate(container_cpu_cfs_throttled_seconds_total{dh_cluster="$dh_cluster",
            namespace="$namespace", container!="POD", container!="", pod=~".*$app.*"}[$__rate_interval]))
          legendFormat: '{{pod}} - {{container}}'
      type: graph
    - title: Pod Ready
      datasource: q5KtSq17z
      span: 4
      legend:
        alignAsTable: true
        current: false
        sort: current
        show: true
        values: true
        sortDesc: true
      tooltip:
        shared: true
        sort: 2
        value_type: individual
      stack: true
      targets:
        - expr: >-
            sum by (condition) (kube_pod_status_ready{dh_cluster="$dh_cluster", namespace="$namespace",
            pod=~".*$app.*", condition="true"})
          legendFormat: '{{ condition }}'
        - expr: >-
            sum by (condition) (kube_pod_status_ready{dh_cluster="$dh_cluster", namespace="$namespace",
            pod=~".*$app.*", condition="false"})
          legendFormat: '{{ condition }}'
        - expr: >-
            kube_pod_status_ready{dh_cluster="$dh_cluster", namespace="$namespace", pod=~".*$app.*",
            condition="false"} > 0
          legendFormat: 'Not ready: {{ pod }}'
      seriesOverrides:
        - alias: '/true|false/'
          legend: false
        - alias: 'true'
          color: green
        - alias: 'false'
          color: red
        - alias: '/Not ready/'
          stack: false
          lines: false
          hideTooltip: true
      type: graph
